<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Native Echo</title>
  <style>
    /* Hacker/Matrix Theme Styles */
    body {
      background-color: #000;
      color: #0f0;
      font-family: 'Courier New', Courier, monospace;
      margin: 20px;
    }
    /* GitHub Link Styling */
    #githubLink {
      font-size: 1em;
      margin-bottom: 10px;
      display: block;
      color: #0f0;
      text-decoration: underline;
    }
    /* Animated title styling */
    #animatedTitle {
      font-size: 3em;
      margin-bottom: 20px;
      letter-spacing: 2px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: #0f0;
    }
    input, select, textarea {
      width: 100%;
      margin-top: 5px;
      padding: 5px;
      background: #111;
      border: 1px solid #0f0;
      color: #0f0;
    }
    button {
      margin-top: 15px;
      padding: 8px 16px;
      background: #0a0;
      color: #000;
      border: none;
      cursor: pointer;
      font-family: 'Courier New', Courier, monospace;
    }
    button:hover {
      background: #0c0;
    }
    /* 2x2 Grid Layout */
    #gridContainer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 20px;
      margin-top: 20px;
    }
    /* Top Left: Video cell */
    #videoCell {
      border: 1px solid #0f0;
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
      display: none;
    }
    /* Top Right: Translated Captions cell */
    #translatedCell {
      border: 1px solid #0f0;
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
      display: none;
    }
    /* Bottom Left: Collapsible English Captions cell */
    #englishCell {
      border: 1px solid #0f0;
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
      display: none;
    }
    #englishHeader {
      cursor: pointer;
      margin: 0;
      font-size: 1.2em;
    }
    #englishCaptionsContainer {
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    /* Bottom Right: Logs cell */
    #logsCell {
      border: 1px solid #0f0;
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
      display: none;
    }
    #outputLog {
      white-space: pre-wrap;
      color: #0f0;
      max-height: 200px;
      overflow-y: auto;
    }
    .caption-block {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- GitHub link -->
  <a id="githubLink" href="https://github.com/anonUnderground/NativeEcho" target="_blank">
    Check out the GitHub
  </a>
  
  <!-- Animated Title -->
  <h1 id="animatedTitle"></h1>
  
  <!-- Input and Controls -->
  <label for="youtubeUrl">YouTube Link:</label>
  <input type="text" id="youtubeUrl" maxlength="150" placeholder="https://www.youtube.com/watch?v=..." />
  
  <label for="languageSelect">Translate Captions To:</label>
  <select id="languageSelect">
    <option value="es">Spanish (es)</option>
    <option value="fr">French (fr)</option>
    <option value="de">German (de)</option>
    <option value="it">Italian (it)</option>
  </select>
  
  <button id="fetchCaptionsBtn">Fetch Captions</button>
  <button id="bulkTranslateBtn" disabled>Bulk Translate</button>
  
  <!-- 2x2 Grid Layout -->
  <div id="gridContainer">
    <!-- Top Left: Video -->
    <div id="videoCell">
      <h2 id="videoTitle"></h2>
      <div id="videoEmbed"></div>
    </div>
    
    <!-- Top Right: Translated Captions -->
    <div id="translatedCell">
      <h2>Translated Captions</h2>
      <div id="translatedCaptions"></div>
    </div>
    
    <!-- Bottom Left: Collapsible English Captions -->
    <div id="englishCell">
      <h2 id="englishHeader">English Captions (click to toggle)</h2>
      <div id="englishCaptionsContainer"></div>
    </div>
    
    <!-- Bottom Right: Logs -->
    <div id="logsCell">
      <h2>Logs</h2>
      <pre id="outputLog"></pre>
    </div>
  </div>
  
  <script>
    // Typing animation for "Native Echo"
    document.addEventListener('DOMContentLoaded', function() {
      const titleText = "Native Echo";
      let index = 0;
      const titleElement = document.getElementById('animatedTitle');
      function typeLetter() {
        if (index < titleText.length) {
          titleElement.textContent += titleText.charAt(index);
          index++;
          setTimeout(typeLetter, 150);
        }
      }
      typeLetter();
    });
    
    // Global variable: each caption is an object { start, text, translatedText }
    let globalCaptions = [];
    
    // Update the Translated Captions box exactly as originally implemented.
    function updateTranslatedCaptions() {
      const container = document.getElementById("translatedCaptions");
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      globalCaptions.forEach((cap, index) => {
        const div = document.createElement("div");
        div.className = "caption-block";
        const displayText = cap.translatedText ? cap.translatedText : "(no translation)";
        div.textContent = `[${index+1}] (${cap.start}s): ${displayText}`;
        container.appendChild(div);
      });
    }
    
    // Update the English Captions box.
    function updateEnglishCaptions() {
      const container = document.getElementById("englishCaptionsContainer");
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      globalCaptions.forEach((cap, index) => {
        const div = document.createElement("div");
        div.className = "caption-block";
        div.textContent = `[${index+1}] (${cap.start}s): ${cap.text}`;
        container.appendChild(div);
      });
    }
    
    // Toggle the English Captions box visibility.
    document.getElementById("englishHeader").addEventListener("click", function() {
      const englishContainer = document.getElementById("englishCaptionsContainer");
      if (englishContainer.style.display === "none" || englishContainer.style.display === "") {
        englishContainer.style.display = "block";
      } else {
        englishContainer.style.display = "none";
      }
    });
    
    // Fetch captions and video details.
    document.getElementById("fetchCaptionsBtn").addEventListener("click", async () => {
      const youtubeUrl = document.getElementById("youtubeUrl").value.trim();
      const outputLog = document.getElementById("outputLog");
      
      if (!youtubeUrl) {
        outputLog.textContent = "Please enter a valid YouTube link.";
        return;
      }
      
      outputLog.textContent = "Fetching captions from /process...";
      
      try {
        const response = await fetch("/process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ youtube_url: youtubeUrl })
        });
        
        if (!response.ok) {
          const errText = await response.text();
          outputLog.textContent = "Error fetching captions:\n" + errText;
          return;
        }
        
        const data = await response.json();
        if (!data.captions || !Array.isArray(data.captions)) {
          outputLog.textContent = "No captions found or invalid response.";
          return;
        }
        
        // Populate the video container if available.
        if (data.videoDetails && data.videoDetails.embed_html) {
          document.getElementById("videoTitle").textContent = data.videoDetails.title;
          document.getElementById("videoEmbed").innerHTML = data.videoDetails.embed_html;
          document.getElementById("videoCell").style.display = "block";
        }
        
        // Store captions globally.
        globalCaptions = data.captions;
        outputLog.textContent = "Successfully fetched " + globalCaptions.length + " captions.";
        
        // Show grid cells.
        document.getElementById("translatedCell").style.display = "block";
        document.getElementById("englishCell").style.display = "block";
        document.getElementById("logsCell").style.display = "block";
        
        // Update both captions boxes.
        updateTranslatedCaptions();
        updateEnglishCaptions();
        
        // Enable the Bulk Translate button.
        document.getElementById("bulkTranslateBtn").disabled = false;
      } catch (err) {
        outputLog.textContent = "Network or server error:\n" + err.message;
      }
    });
    
    // Bulk translate captions, updating the UI incrementally.
    document.getElementById("bulkTranslateBtn").addEventListener("click", async () => {
      const outputLog = document.getElementById("outputLog");
      const language = document.getElementById("languageSelect").value;
      
      if (globalCaptions.length === 0) {
        outputLog.textContent = "No captions to translate. Please fetch captions first.";
        return;
      }
      
      outputLog.textContent = `Translating ${globalCaptions.length} captions to ${language}...\n\n`;
      
      // Clear the translated captions container.
      const translatedDiv = document.getElementById("translatedCaptions");
      translatedDiv.innerHTML = "";
      
      for (let i = 0; i < globalCaptions.length; i++) {
        const cap = globalCaptions[i];
        const messages = [
          { role: "system", content: `Translate to ${language}` },
          { role: "user", content: cap.text }
        ];
        
        outputLog.textContent += `Translating caption #${i+1} (start=${cap.start}s)...\n`;
        
        try {
          const response = await fetch("/test-translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages })
          });
          
          if (!response.ok) {
            const errText = await response.text();
            outputLog.textContent += `  Error from /test-translate: ${errText}\n`;
            globalCaptions[i].translatedText = "";
            await new Promise(resolve => setTimeout(resolve, 0));
            continue;
          }
          
          const data = await response.json();
          const translatedText = data?.choices?.[0]?.message?.content?.trim() || "(no translation)";
          globalCaptions[i].translatedText = translatedText;
          
          const div = document.createElement("div");
          div.className = "caption-block";
          div.textContent = `[${i+1}] (${cap.start}s): ${translatedText}`;
          translatedDiv.appendChild(div);
          
          outputLog.textContent += `  => ${translatedText}\n`;
          
          await new Promise(resolve => setTimeout(resolve, 0));
        } catch (err) {
          outputLog.textContent += `  Network error: ${err.message}\n`;
          globalCaptions[i].translatedText = "";
          await new Promise(resolve => setTimeout(resolve, 0));
        }
      }
      
      outputLog.textContent += "\nBulk translation complete!";
      updateTranslatedCaptions();
    });
  </script>
</body>
</html>